# Support for handling multiple equivalent framework

- [Nikolche Kolev](https://github.com/nkolev92)
- Start Date: (2022-08-18)
- GitHub Issue ([5154](https://github.com/NuGet/Home/issues/5154)) - Treat Target Framework as Aliases

## Summary

.NET SDK projects are capable of multi targeting based on a target framework where you can have different dependencies for each framework.
In some cases, it is convenient to multi target based on different pivots such as target appplication version or maybe the specific runtime, as packages can contain runtime assets.
This proposals covers the steps that need to be taken to enable that capability.

## Motivation

Allowing the same framework to be using multiple times in restore would allow customers to use the same project to generate runtime specific assemblies based on the same target framework.
It would also allow scenarios such as different builds for VSIXes targeting different Visual Studio versions.

## Explanation

### Functional explanation

#### TargetFramework values are aliases today

NuGet currently treats `TargetFramework` as aliases. For example, the following is a valid project.

```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>banana</TargetFramework>
  </PropertyGroup>

  <PropertyGroup Condition=" '$(TargetFramework)' == 'banana' ">
    <TargetFrameworkIdentifier>.NETFramework</TargetFrameworkIdentifier>
    <TargetFrameworkVersion>v4.7.2</TargetFrameworkVersion>
    <TargetFrameworkMoniker>.NETFramework,Version=v4.7.2</TargetFrameworkMoniker>
  </PropertyGroup>

</Project>
```

```console
C:\Code\Temp\Aliases [main]> dotnet restore
  Determining projects to restore...
  Restored C:\Code\Temp\Aliases\Aliases.csproj (in 47 ms).

C:\Code\Temp\Aliases [main]> dotnet build --framework banana
MSBuild version 17.3.0+92e077650 for .NET
  Determining projects to restore...
  All projects are up-to-date for restore.
  Aliases -> C:\Code\Temp\Aliases\bin\Debug\banana\Aliases.dll

Build succeeded.
    0 Warning(s)
    0 Error(s)

Time Elapsed 00:00:00.27

C:\Code\Temp\Aliases [main]> dotnet publish --framework banana
MSBuild version 17.3.0+92e077650 for .NET
  Determining projects to restore...
  All projects are up-to-date for restore.
  Aliases -> C:\Code\Temp\Aliases\bin\Debug\banana\Aliases.dll
  Aliases -> C:\Code\Temp\Aliases\bin\Debug\banana\publish\
```

The missing part is allowing the same framework to be targeting among these aliases.

The following scenarios would be enabled:

```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFrameworks>latestnet-linux;latestnet-mac</TargetFrameworks>
  </PropertyGroup>

  <PropertyGroup Condition=" '$(TargetFramework)' == 'latestnet-mac' OR '$(TargetFramework)' == 'latestnet-linux'">
    <TargetFrameworkIdentifier>.NETCoreApp</TargetFrameworkIdentifier>
    <TargetFrameworkVersion>v6.0</TargetFrameworkVersion>
    <TargetFrameworkMoniker>.NETCoreApp,Version=v6.0</TargetFrameworkMoniker>
  </PropertyGroup>
  
  </Project>
```

Alternatively, the VS extension scenario would be something like:

```xml
<Project Sdk="Microsoft.VisualStudio.Extensibility.Sdk">

  <PropertyGroup>
    <TargetFrameworks>vs17.2;vs17.3</TargetFrameworks>
  </PropertyGroup>
  
  </Project>
```

### Technical explanation

## NuGet challenges to get there

While this scenario does have a number of interesting uses, there are many commands that would be affected by NuGet supporting this. 

### Build challenges (project.assets.json)

In PackageReference, NuGet has a contract with the .NET SDK, where NuGet writes the assets file and the .NET SDK consumes it. 
In most scenarios, people use `dotnet restore` and `dotnet build --no-restore` and there are no issues.

It is not uncommon that people use `nuget.exe restore` due to the fact that they have non-SDK projects in their solution. 

Given that NuGet.exe and .NET SDK do not ship together, it is super common that the assets file was generated by a newer/older version of NuGet.exe than the .NET SDK can support.
Normally, this works. NuGet rarely makes non-additive changes to the  assets file.

Sample part of an assets file:

```json
  "targets": {
    ".NETFramework,Version=v4.7.2": {},
    ".NETFramework,Version=v4.8.0": {}
  },

```

NuGet's assets file is written pivoting on the actual target framework.

Action items:

- NuGet side proposal to change the assets file.
- NuGet side heuristic to determine the best version of the assets file.
- What happens when the combination of new NuGet.exe with old .NET SDK happens. Servicing old versions of tooling usually has a higher bar.
- Old NuGet.exe with new .NET SDK isn't as big of a concern, because NuGet already raises an error today, but the error message could be made more actionable.

### Restore challenges

- In addition to the assets file, restore has a lock file which has a similar schema, that schema would need to be amended.
- NuGet's intra restore caching is based on the existing of a single framework. It is difficult to predict the amount of work that'd be required to implement this correctly, but it'll certainly involve public API changes to NuGet libraries. (NuGet ships libraries, NuGet.exe, VS and dotnet.exe)

### Pack challenges

Multi-targetted pack only really works when each build leg (TargetFramework value) has 1 target location such as `lib/net5.0`. The story here needs some work.

Pack - controlled chaos - It is ok if this doesn't work.

### dotnet.exe challenges

Today, some values in dotnet.exe work with an aliased `TargetFramework`, such as `build` and `publish`.  We'd need to verify all other commands

#### dotnet.exe list package

- Would require output changes and potential schema changes for the machine readable output (only when necessary).

#### Visual Studio PM UI challenges

Current the PM UI does not have any support for multi targeting. This isn't anything new, but it can affect the experience of customers moving to SDK projects for the first time.

## Drawbacks

<!-- Why should we not do this? -->

## Rationale and alternatives

<!-- Why is this the best design compared to other designs? -->
<!-- What other designs have been considered and why weren't they chosen? -->
<!-- What is the impact of not doing this? -->

## Prior Art

<!-- What prior art, both good and bad are related to this proposal? -->
<!-- Do other features exist in other ecosystems and what experience have their community had? -->
<!-- What lessons from other communities can we learn from? -->
<!-- Are there any resources that are relevant to this proposal? -->

## Unresolved Questions

<!-- What parts of the proposal do you expect to resolve before this gets accepted? -->
<!-- What parts of the proposal need to be resolved before the proposal is stabilized? -->
<!-- What related issues would you consider out of scope for this proposal but can be addressed in the future? -->

## Future Possibilities

<!-- What future possibilities can you think of that this proposal would help with? -->